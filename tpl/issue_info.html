<div id="content">
   <script type="text/javascript" src="js_min/datepicker.min.js"></script>

   {if isset($projects)}
   <div class="center" style="margin-top: 2em">
      <form id="form1" name="form1" class="formWithTabsHistory" method="get" action="{$page}">
         <fieldset>
            <select id="projectid" title="{t}Project{/t}">
              {foreach from=$projects key=id item=i}
               <option {if $i.selected}selected="selected"{/if} value="{$i.id}">{$i.name}</option>
               {/foreach}
            </select>
            <span id="bugSelector">
            {include file="form/bugSelector.html"}
            </span>
            {if isset($support)}<input type="hidden" name="support" />{/if}
            <input type="submit" value="{t}Select{/t}" />
         </fieldset>
      </form>

      <script type="text/javascript">
      </script>

   </div>

   <div id="result">

      <!-- Title -->
      {if isset($issueGeneralInfo)}

      <div style="margin-top:2em;">{include file="modal/consistency_check.html"}</div>

      <div class="center">
         <!--{if $issueGeneralInfo.issueExtRef}<span title="{t}External ID{/t}">{$issueGeneralInfo.issueExtRef}</span>{/if}-->
         <h2>{$issueGeneralInfo.mantisURL} {$issueGeneralInfo.issueURL} : {$issueGeneralInfo.issueSummary}</h2>
      </div>

      <div id="divCmds" style="margin-top:2em;">
         <table class="invisible">
            <tbody>
               <tr>
                  <td style="vertical-align:top; font-weight:bold;">{t}Commands{/t} : </td>
                  <td>
                     <div id="cmdList">
                     {foreach from=$parentCommands key=id item=i}
                     <div id="divCmd_{$i.id}">
                     {if $isManager}
                     <span class="pointer"><img onclick="removeFromCmd('{$i.id}', '{$i.name|escape}');return false;" align="absmiddle" title="{t}Remove from command{/t}" src="images/b_drop.png"/></span>
                     {/if}
                     <a href='management/command_info.php?cmdid={$i.id}'>{if isset($i.reference)}{$i.reference} {/if}{$i.name}</a>
                     </div>
                     {/foreach}
                     </div>
                     {if $isManager}
                     <div id="divAddCmd">
                     <span id="addToCmd_link" class="pointer"><img align="absmiddle" title="{t}Add to command{/t}" src="images/b_add2.gif"/></span>
                     <span class="help_font">{t}Add to command{/t}</span>
                     </div>
                     {/if}
                  </td>
               </tr>
            </tbody>
         </table>
      </div>

      <div id="tabsIssueInfo" class="tabs {$ui_tabs_jquery}" style="margin-top:1em;">
         <ul class="{$ui_tabs_jquery_ul}">
            <li class="{$ui_tabs_jquery_li}"><a href="#tab_overview">{t}Properties{/t}</a></li>
            <li class="{$ui_tabs_jquery_li}"><a href="#tab_timetracks">{t}Timetracks{/t}</a></li>
            <li class="{$ui_tabs_jquery_li}"><a href="#tab_indicators">{t}Indicators{/t}</a></li>
         </ul>

         <div id="tab_indicators">{include file="tools/dashboard.html"}</div>

         <div id="tab_overview">

            <!-- General info -->
            <h3>
               <span id="updateTimetracking_link" >{t}Time tracking{/t} 
                  {if ! $isObserver}
                  &nbsp;&nbsp;<img class="pointer" align="absmiddle" title="{t}Update timetracking{/t}" src="images/b_edit.png"/>
                  {/if}
               </span>
            </h3>
            <div id="issueGeneralInfo" style="margin-top:0.5em;">
               {include file="ajax/issueGeneralInfo.html"}
            </div>

            <div id="divTaskInfo" style="margin-top:2em;">
               <h3>
                  <span id="updateTaskInfo_link" >{t}Task Info{/t} 
                     {if ! $isObserver}
                     &nbsp;&nbsp;<img class="pointer" align="absmiddle" title="{t}Update task info{/t}" src="images/b_edit.png"/>
                     {/if}
                  </span>
               </h3>
               <table class="center" style="margin-top:0.5em;">
                  <thead>
                     <tr>
                        <th>{t}External Ref{/t}</th>
                        <th>{t}Assigned to{/t}</th>
                        <th>{t}Status{/t}</th>
                        <th>{t}Project{/t}</th>
                        <th>{t}Category{/t}</th>
                        <th>{t}Type{/t}</th>
                        <th>{t}Priority{/t}</th>
                        <th>{t}Severity{/t}</th>
                        <th title="{t}Target version{/t}">{t}Target{/t}</th>
                        <th>{t}Deadline{/t}</th>
                     </tr>
                  </thead>
                  <tbody>
                     <tr>
                        <td id="ti_issueExtRef">{$issueGeneralInfo.issueExtRef}</td>
                        <td id="ti_handlerName">{$issueGeneralInfo.handlerName}</td>
                        <td id="ti_statusName">{$issueGeneralInfo.statusName}</td>
                        <td id="ti_projectName">{$issueGeneralInfo.projectName}</td>
                        <td id="ti_categoryName">{$issueGeneralInfo.categoryName}</td>
                        <td id="ti_issueType">{$issueGeneralInfo.issueType}</td>
                        <td id="ti_priorityName">{$issueGeneralInfo.priorityName}</td>
                        <td id="ti_severityName">{$issueGeneralInfo.severityName}</td>
                        <td id="ti_targetVersion" title="{$issueGeneralInfo.targetVersionDate}">{$issueGeneralInfo.targetVersion}</td>
                        <td id="ti_deadLine">
                        {if isset($timeDrift.deadLine)}
                           {$timeDrift.deadLine}
                           {$timeDrift.tooltip}
                        {/if}
                        </td>
                     </tr>
                     <tr>
                        <td colspan="10" title="{t}Description{/t}"><textarea rows='6' style="border: none; width: 100%; -webkit-box-sizing: border-box; -moz-box-sizing: border-box; box-sizing: border-box;">{$issueGeneralInfo.issueDescription}</textarea></td>
                     </tr>
                  </tbody>
               </table>
            </div>

            <div id="divRelationships" style="margin-top:2em;">
               {if $issueGeneralInfo.relationships}
               <!-- Relationships details -->
               <table class="invisible">
                  <tr>
                     <td>
                        <table>
                             <tr>
                                <th valign="top">{t}Relation{/t}</th>
                                <th valign="top">{t}Task{/t}</th>
                                <th valign="top">{t}Status{/t}</th>
                                <th valign="top">{t}Progress{/t}</th>
                                <th valign="top">{t}Summary{/t}</th>
                             </tr>
                           <tbody>
                          {foreach $issueGeneralInfo.relationships as $relatedIssue}
                             <tr>
                                   <td>{$relatedIssue.relationship}</td>
                                   <td>{$relatedIssue.url}</td>
                                   <td>{$relatedIssue.status}</td>
                                   <td>{$relatedIssue.progress}%</td>
                                   <td>{$relatedIssue.summary}%</td>
                             </tr>
                          {/foreach}
                          </tbody>
                       </table>
                     </td>
                  </tr>
               </table>
               {/if}
            </div>
            <div id="divMantisNotes" style="margin-top:2em;">
               <h3>
                  <span id="getMantisNotes_link" >{t}Mantis notes{/t}
                     &nbsp;&nbsp;<img class="pointer" align="absmiddle" title="{t}Get mantis notes{/t}" src="images/b_refresh.png"/>
                  </span>
               </h3>
               <div id="divNotesInfo" style="margin-top:0.5em;">
                  <label class="help_font">{t}Click refresh button to display...{/t}</label>
               </div>
               <div id="divNotesTable"  style="display: none; margin-top:0.5em;">
                  <table id="tableMantisNotes">
                     <thead>
                     <tr>
                        <th valign="top">{t}Date{/t}</th>
                        <th valign="top">{t}User{/t}</th>
                        <th valign="top">{t}Note{/t}</th>
                     </tr>
                     </thead>
                     <tbody>
                        <!-- filled by ajax -->
                     </tbody>
                 </table>
              </div>
            </div>

            <div class="ui-helper-clearfix"></div>
         </div>

         <div id="tab_timetracks">
            <!-- Jobs details by months -->
            {if $months}
            {foreach from=$months key=id item=i}
            <table width="70%" style="margin-bottom: 2em;">
               <caption>{$i.monthFormated} <span style="margin-left: 1em;font-weight: normal; font-size: 12px">{$i.totalDuration} {t}days{/t}</span></caption>
               <thead>
                  <tr>
                     <th></th>
                     {foreach from=$i.months key=id item=j}
                     <th>{$j}</th>
                     {/foreach}
                     <th>TOTAL</th>
                  </tr>
               </thead>
               <tbody>
                  {foreach from=$i.users key=id item=k}
                  <tr>
                     <td>{$k.username}</td>
                     {foreach from=$k.jobs key=id item=l}
                     <td style="{if isset($l.jobColor)}background-color: #{$l.jobColor};{/if} text-align: center;" {if isset($l.jobDescription)}title="{$l.jobDescription}"{/if}>{if isset($l.jobDuration)}{$l.jobDuration}{/if}</td>
                     {/foreach}
                     <th>{$k.totalDuration}</th>
                  </tr>
                  {/foreach}
               </tbody>
            </table>
            {/foreach}

            <!-- legend -->
            {foreach from=$jobDetails key=id item=i}
            <div class="float" style="margin-right: 1em;">
               <div class="generatedImage float" style="background-color: #{$i.jobColor};"></div>
               <div class="float">{$i.jobName}</div>
               <div class="ui-helper-clearfix"></div>
            </div>
            {/foreach}
            <div class="ui-helper-clearfix"></div>
            {/if}
         </div>
      </div>
      {/if}

      <div id="formUpdateTimetracking_dialog" title="{t}Update timetracking values{/t}" class="ui-helper-hidden">
         <form id="formUpdateTimetracking" name="formUpdateTimetracking" method="get" action="{$ajaxPage}" >
            <fieldset>
               <label style="margin-top: 1em"><b>{t}Task{/t} : </b>{$issueGeneralInfo.issueId}{if isset($issueGeneralInfo.issueExtRef)} / {$issueGeneralInfo.issueExtRef}{/if}</label>
               <table style="margin-top: 1em">
                  <tbody>
                     <tr>
                        {if $isManager}
                        <th>{t}MgrEffortEstim{/t}</th>
                        {/if}
                        <th>{t}EffortEstim{/t}</th>
                        <th>{t}Backlog{/t}</th>
                     </tr>
                     <tr>
                        {if $isManager}
                        <td><input type="text" id="fut_issueMgrEffortEstim" name="fut_issueMgrEffortEstim" class="text" style="width: 100%; -webkit-box-sizing: border-box; -moz-box-sizing: border-box; box-sizing: border-box;"/></td>
                        {/if}
                        <td><input type="text" id="fut_issueEffortEstim" name="fut_issueEffortEstim" class="text" style="width: 100%; -webkit-box-sizing: border-box; -moz-box-sizing: border-box; box-sizing: border-box;" /></td>
                        <td><input type="text" id="fut_backlog" name="fut_backlog" class="text" style="width: 100%; -webkit-box-sizing: border-box; -moz-box-sizing: border-box; box-sizing: border-box;" /></td>
                     </tr>
                  </tbody>
               </table>
               <label id="fut_validateTips" class="error_font" ></label>
               <input type="hidden" name="action" value="updateTimetracking" />
               <input type="hidden" name="bugid"  value="{$issueGeneralInfo.issueId}" />
            </fieldset>
         </form>
      </div>
      {if $isManager}
      <div id="formRemoveFromCmd_dialog" title="{t}Remove from Command{/t}" class="ui-helper-hidden">
         <p><span class="ui-icon ui-icon-alert float" style="margin-right: 7px;"></span>
            {t}Remove from :{/t} <span id="formRemoveFromCmd_cmdName">cmdName</span>
         </p>
         <form id="formRemoveFromCmd" name="formRemoveFromCmd" method="get" action="{$ajaxPage}" >
            <fieldset>
               <input type="hidden" name="action" value="removeFromCmd" />
               <input type="hidden" name="bugid"  value="{$issueGeneralInfo.issueId}" />
               <input type="hidden" name="cmdid"  value="0" />
            </fieldset>
         </form>
      </div>
      <div id="formAddToCmd_dialog" title="{t}Add to Command{/t}" class="ui-helper-hidden">
         <form id="formAddToCmd" name="formAddToCmd" method="get" action="{$ajaxPage}" >
            <fieldset>
               {t}Command{/t} :
               <select class="cbCmdCandidates" name="cmdid" style="margin-left:1em;  width:400px;">
               </select>
               <input type="hidden" name="action" value="addToCmd" />
               <input type="hidden" name="bugid"  value="{$issueGeneralInfo.issueId}" />
            </fieldset>
         </form>
      </div>
      {/if}
      <div id="formUpdateTaskInfo_dialog" title="{t}Update task info{/t}" class="ui-helper-hidden">
         <form id="formUpdateTaskInfo" name="formUpdateTaskInfo" method="get" action="{$ajaxPage}" >
            <fieldset>

               <table class="invisible">
                  <tbody>
                     <tr>
                        <th><label>{t}Task{/t} :</label></th>
                        <td><label>{$issueGeneralInfo.issueId}{if isset($issueGeneralInfo.issueExtRef)} / {$issueGeneralInfo.issueExtRef}{/if}</label></td>
                        <td></td>
                     </tr>
                     <tr>
                        <th><label for="futi_extRef">{t}External Ref{/t} :</label></th>
                        <td><input type="text" id="futi_extRef" name="futi_extRef" size="15" class="text" /></td>
                        <td></td>
                     </tr>
                     <tr>
                        <th><label for="futi_cbHandlerId">{t}Assigned to{/t} :</label></th>
                        <td><select id="futi_cbHandlerId" name="futi_cbHandlerId"> </select></td>
                        <td></td>
                     </tr>
                     <tr>
                        <th><label for="futi_cbStatus">{t}Status{/t} :</label></th>
                        <td><select id="futi_cbStatus" name="futi_cbStatus"> </select></td>
                        <td></td>
                     </tr>
                     <tr>
                        <th><label for="futi_codevttType">{t}Type{/t} :</label></th>
                        <td><select id="futi_codevttType" name="futi_codevttType">
                              <option value="Bug">Bug</option>
                              <option value="Task">Task</option>
                           </select>
                        </td>
                        <td></td>
                     </tr>
                     <!--tr>
                        <th><label for="futi_priority">{t}Priority{/t} :</label></th>
                        <td><select id="futi_priority" name="futi_priority"> </select></td>
                        <td></td>
                     </tr>
                     <tr>
                        <th><label for="futi_severity">{t}Severity{/t} :</label></th>
                        <td><select id="futi_severity" name="futi_severity"> </select></td>
                        <td></td>
                     </tr-->
                     <tr>
                        <th><label for="futi_cbTargetVersion">{t}Target{/t} :</label></th>
                        <td><select id="futi_cbTargetVersion" name="futi_cbTargetVersion"> </select></td>
                        <td></td>
                     </tr>
                     <tr>
                        <th><label for="futi_deadlineDatepicker">{t}Deadline{/t} :</label></th>
                        <td>
                           <input type="text"  class="datepicker" id="futi_deadlineDatepicker" name="futi_deadlineDatepicker" autocomplete="off" maxlength="10" size="10" />
                           <input type="checkbox" title="{t}set/remove task specific deadline{/t}" id="futi_isDeadline" name="futi_isDeadline" style="vertical-align: middle;"/>
                        </td>
                        <td></td>
                     </tr>
                     <tr>
                        <th><label for="futi_deliveryDatepicker">{t}Delivery date{/t} :</label></th>
                        <td>
                           <input type="text"  class="datepicker" id="futi_deliveryDatepicker" name="futi_deliveryDatepicker" autocomplete="off" maxlength="10" size="10" />
                           <input type="checkbox" title="{t}set/remove delivery date{/t}" id="futi_isDelivery" name="futi_isDelivery" style="vertical-align: middle;"/>
                        </td>
                        <td></td>
                     </tr>
                  </tbody>
               </table>
               <label id="futi_validateTips" class="error_font" ></label>
               <input type="hidden" name="action" value="updateTaskInfo" />
               <input type="hidden" name="bugid"  value="{$issueGeneralInfo.issueId}" />
            </fieldset>
         </form>
      </div>

   </div>


   <script type="text/javascript">

      function removeFromCmd(cmdid, cmdName){
         //var dialog = jQuery("#formRemoveFromCmd_dialog");
         //dialog.find(".desc_id").text(commandsetid);
         jQuery("#formRemoveFromCmd_cmdName").text(cmdName);
         jQuery("#formRemoveFromCmd").find("input[name=cmdid]").val(cmdid);
         jQuery("#formRemoveFromCmd_dialog").dialog( "open" );
      }
      function updateGeneralInfo() {
         var bugid = {$issueGeneralInfo.issueId}; //jQuery("#bugid").val();
         jQuery.ajax({
            type: "GET",
            url: "reports/issue_info_ajax.php",
            data: "action=getGeneralInfo&bugid="+bugid,
            success: function(data) {
               jQuery("#issueGeneralInfo").html(jQuery.trim(data));
               updateWidgets("#issueGeneralInfo");
            },
            error: function(jqXHR, textStatus, errorThrown) {
               if(errorThrown == 'Forbidden') {
                  window.location = '{$page}';
               } else {
                  alert(errorThrown);
               }
            }
         });
      }

      jQuery(document).ready(function() {

      // =================================================================
      // Task selection form

      jQuery("#projectid").change(function() {
         var projectid = jQuery(this).val();
         jQuery.ajax({
            type: "GET",
            url: "smarty_tools_ajax.php",
            data: "action=getProjectIssues&projectid="+projectid+"&bugid="+jQuery("#bugid").val(),
            success: function(data) {
               jQuery("#bugSelector").html(jQuery.trim(data));
               updateWidgets("#bugSelector");

               // Hide result because the form is no more consistent with the result
               jQuery("#result").hide();
            },
            error: function(jqXHR, textStatus, errorThrown) {
               if(errorThrown === 'Forbidden') {
                  window.location = '{$page}';
               } else {
                  console.error(textStatus, errorThrown);
                  alert(errorThrown);
               }
            }
         });
      });

      jQuery("#bugid").change(function() {
            console.log('submit form1');
         if ('0' !== this.value) {
            var form = jQuery('#form1');
            form.submit();
         }
      });

      // =================================================================
      var fut_backlog = jQuery("#fut_backlog"),
          fut_issueMgrEffortEstim = jQuery("#fut_issueMgrEffortEstim"),
          fut_issueEffortEstim = jQuery("#fut_issueEffortEstim"),
          fut_allFields = jQuery([]).add(fut_backlog).add(fut_issueMgrEffortEstim).add(fut_issueEffortEstim);

      // used to check formUpdateTimetracking_dialog values
      var bugResolvedStatusThreshold, bugStatusNew, statusNameNew, currentStatus;


      function checkRegexp(oField, regexp, oMsgLabel, msg) {
         if (!(regexp.test(oField.val()))) {
            oField.addClass("ui-state-error");
            oMsgLabel.text(msg); // .addClass("ui-state-highlight");
            //setTimeout(function() { oMsgLabel.removeClass("ui-state-highlight", 1500); }, 500);
            return false;
         } else {
            return true;
         }
      }

      function checkStatus(oBacklog, oMsgLabel) {
         if ((currentStatus < bugResolvedStatusThreshold) && (0 == oBacklog.val())) {
            oBacklog.addClass("ui-state-error");
            oMsgLabel.text("{t}Task not resolved, backlog cannot be '0'{/t}");
            return false;
         }
         if ((currentStatus >= bugResolvedStatusThreshold) && (0 != oBacklog.val())) {
            oBacklog.addClass("ui-state-error");
            oMsgLabel.text("{t}Task is resolved, backlog should be '0'{/t}");
            //return false;
         }
         if ((currentStatus == bugStatusNew) && (0 < oBacklog.val())) {
            oBacklog.addClass("ui-state-error");
            oMsgLabel.text("{t}Status can't be : {/t}" + statusNameNew);
            return false;
         }
         return true;
      }

      function isTimetrackingFieldsValid() {

         var bValid = true;
         var fut_validateTips = jQuery("#fut_validateTips");
         fut_allFields.removeClass("ui-state-error");
         fut_validateTips.text('');
         {if $isManager}
         bValid = bValid && checkRegexp(fut_issueMgrEffortEstim, /^[0-9]+(\.[0-9][0-9]?5?)?$/i, fut_validateTips, "format:  '1',  '0.3'  or  '2.55' or '2.125'");
         {/if}
         bValid = bValid && checkRegexp(fut_issueEffortEstim, /^[0-9]+(\.[0-9][0-9]?5?)?$/i, fut_validateTips, "format:  '1',  '0.3'  or  '2.55' or '2.125'");
         bValid = bValid && checkRegexp(fut_backlog, /^[0-9]+(\.[0-9][0-9]?5?)?$/i, fut_validateTips, "format:  '1',  '0.3'  or  '2.55' or '2.125'");
         bValid = bValid && checkStatus(fut_backlog, fut_validateTips);
         return bValid;
      }

         // =================================================================
         jQuery("#updateTimetracking_link").click(function(e) {
            e.preventDefault();

            // fill cmdCandidates
            jQuery.ajax({
               type: "GET",
               url: "{$ajaxPage}",
               data: "action=getTimetracking&bugid={$issueGeneralInfo.issueId}",
               dataType:"json",
               success: function(data) {
                  if ('SUCCESS' === data.statusMsg) {

                     fut_issueMgrEffortEstim.val(data.issueMgrEffortEstim);
                     fut_issueEffortEstim.val(data.issueEffortEstim);
                     fut_backlog.val(data.issueBacklog);

                     bugResolvedStatusThreshold = data.bugResolvedStatusThreshold;
                     bugStatusNew = data.bugStatusNew;
                     statusNameNew = data.statusNameNew;
                     currentStatus = data.issueCurrentStatus;

                     checkStatus(fut_backlog, jQuery("#fut_validateTips"));
                     jQuery("#formUpdateTimetracking_dialog").dialog("open");
                  } else {
                     console.error("Ajax statusMsg", data.statusMsg);
                     alert(data.statusMsg);
                  }
               },
               error: function(jqXHR, textStatus, errorThrown) {
                  console.error(textStatus, errorThrown);
                  alert("ERROR: Please contact your CodevTT administrator");
               }
            });
         });

         jQuery("#formUpdateTimetracking_dialog").dialog({
            autoOpen: false,
            resizable: true,
            width: "auto",
            modal: true,
            buttons: {
               "{t}Update{/t}": function() {
                  var bValid = isTimetrackingFieldsValid();
                  if (bValid) {
                     jQuery("#formUpdateTimetracking").submit();
                  }
               },
               "{t}Cancel{/t}": function() {
                  jQuery(this).dialog("close");
               }
            }
         });
         jQuery("#formUpdateTimetracking").submit(function(event) {
            event.preventDefault();
            var form = jQuery(this);
            jQuery.ajax({
               type: form.attr("method"),
               url: form.attr("action"),
               data: form.serialize(),
               dataType:"json",
               success: function(data) {
                  if ('SUCCESS' === data.statusMsg) {
                     // values saved, update displayed values
                     updateGeneralInfo();
                  } else {
                     alert(data.statusMsg);
                  }
               },
               error: function(jqXHR, textStatus, errorThrown) {
                  console.error(textStatus, errorThrown);
                  alert("ERROR: Please contact your CodevTT administrator");
               }
            });
            jQuery("#formUpdateTimetracking_dialog").dialog("close");
         });

         // =================================================================
         jQuery("#updateTaskInfo_link").click(function(e) {
            e.preventDefault();

            // TODO Ajax to update dialog fields/combobox with current values
            jQuery.ajax({
               type: "GET",
               url: "{$ajaxPage}",
               data: "action=getTaskInfo&bugid={$issueGeneralInfo.issueId}",
               dataType:"json",
               success: function(data) {
                  if ('SUCCESS' === data.statusMsg) {
                     jQuery('#futi_extRef').val(data.extRef);
                     jQuery('#futi_codevttType').val(data.codevttType);
                     var cb = jQuery("#futi_cbHandlerId");
                     cb.empty();
                     cb.append(new Option('', '0'));
                     var candidates = data.availableHandlerList;
                     for (var id in candidates) {
                        if (candidates.hasOwnProperty(id)) {
                           cb.append(
                              jQuery('<option>').attr('value', id).append(candidates[id])
                           );
                        }
                     }
                     cb.val(data.currentHandlerId);
                     cb = jQuery("#futi_cbStatus");
                     cb.empty();
                     candidates = data.availableStatusList;
                     for (var id in candidates) {
                        if (candidates.hasOwnProperty(id)) {
                           cb.append(
                              jQuery('<option>').attr('value', id).append(candidates[id])
                           );
                        }
                     }
                     cb.val(data.currentStatus);
                     cb = jQuery("#futi_cbTargetVersion");
                     cb.empty();
                     cb.append(new Option('', '0'));
                     candidates = data.availableTargetVersion;
                     for (var id in candidates) {
                        if (candidates.hasOwnProperty(id)) {
                           cb.append(
                              jQuery('<option>').attr('value', id).append(candidates[id])
                           );
                        }
                     }
                     cb.val(data.targetVersionId);

                     jQuery('#futi_deadlineDatepicker').val(data.deadline);
                     if (data.deadline) {
                        jQuery('#futi_deadlineDatepicker').val(data.deadline);
                        jQuery("#futi_deadlineDatepicker").removeAttr('disabled');
                        $('#futi_isDeadline').prop('checked', true);
                     } else {
                        $('#futi_isDeadline').prop('checked', false);
                        jQuery("#futi_deadlineDatepicker").attr("disabled", "true");
                     }
                     if (data.deliveryDate) {
                        jQuery('#futi_deliveryDatepicker').val(data.deliveryDate);
                        jQuery("#futi_deliveryDatepicker").removeAttr('disabled');
                        $('#futi_isDelivery').attr('checked', true);
                     } else {
                        $('#futi_isDelivery').attr('checked', false);
                        jQuery("#futi_deliveryDatepicker").attr("disabled", "true");
                     }
                     jQuery("#formUpdateTaskInfo_dialog").dialog("open");
                  } else {
                     console.error("statusMsg", data.statusMsg);
                     alert(data.statusMsg);
                  }
               },
               error: function(jqXHR, textStatus, errorThrown) {
                  console.error(textStatus, errorThrown);
                  alert("ERROR: Please contact your CodevTT administrator");
               }
            });

         });
         jQuery("#formUpdateTaskInfo_dialog").dialog({
            autoOpen: false,
            resizable: true,
            width: "auto",
            modal: true,
            buttons: {
               "{t}Update{/t}": function() {
                  jQuery("#formUpdateTaskInfo").submit();
               },
               "{t}Cancel{/t}": function() {
                  jQuery(this).dialog("close");
               }
            }
         });
         jQuery("#formUpdateTaskInfo").submit(function(event) {
            event.preventDefault();
            var form = jQuery(this);
            jQuery.ajax({
               type: form.attr("method"),
               url: form.attr("action"),
               data: form.serialize(),
               dataType:"json",
               success: function(data) {
                  if ('SUCCESS' === data.statusMsg) {
                     jQuery('#ti_issueExtRef').text(data.issueExtRef);
                     jQuery('#ti_handlerName').text(data.handlerName);
                     jQuery('#ti_statusName').text(data.statusName);
                     jQuery('#ti_projectName').text(data.projectName);
                     jQuery('#ti_categoryName').text(data.categoryName);
                     jQuery('#ti_issueType').text(data.issueType);
                     jQuery('#ti_priorityName').text(data.priorityName);
                     jQuery('#ti_severityName').text(data.severityName);
                     jQuery('#ti_targetVersion').text(data.targetVersion);
                     var timeDrift = data.timeDrift;
                     jQuery('#ti_deadLine').empty();
                     if (timeDrift.tooltip && timeDrift.deadLine) {
                        jQuery('#ti_deadLine').html(timeDrift.deadLine + ' ' + timeDrift.tooltip);
                     } else {
                        jQuery('#ti_deadLine').html(timeDrift.deadLine);
                     }
                     updateWidgets("#divTaskInfo"); // TODO why error ?

                     // if status changed, Backlog & progress may need update
                     if ('yes' === data.isUpdateGeneralInfo) {
                        updateGeneralInfo();
                     }
                  } else {
                     console.error("statusMsg", data.statusMsg);
                     alert(data.statusMsg);
                  }
               },
               error: function(jqXHR, textStatus, errorThrown) {
                  console.error(textStatus, errorThrown);
                  alert("ERROR: Please contact your CodevTT administrator");
               }
            });
            jQuery("#formUpdateTaskInfo_dialog").dialog("close");
         });

         jQuery("#futi_isDeadline").change(function() {
               if ($(this).is(":checked")) {
                  jQuery("#futi_deadlineDatepicker").removeAttr('disabled');
               } else {
                  jQuery("#futi_deadlineDatepicker").attr("disabled", "true");
               }
         });
         jQuery("#futi_isDelivery").change(function() {
               if ($(this).is(":checked")) {
                  jQuery("#futi_deliveryDatepicker").removeAttr('disabled');
               } else {
                  jQuery("#futi_deliveryDatepicker").attr("disabled", "true");
               }
         });

         // =================================================================


         jQuery("#formRemoveFromCmd_dialog").dialog({
            autoOpen: false,
            resizable: true,
            width: "auto",
            modal: true,
            buttons: {
               "{t}Remove{/t}": function() {
                  jQuery("#formRemoveFromCmd").submit();
               },
               Cancel: function() {
                  jQuery(this).dialog("close");
               }
            }
         });

         jQuery("#formRemoveFromCmd").submit(function(event) {
            event.preventDefault();
            var form = jQuery(this);
            jQuery.ajax({
               type: form.attr("method"),
               url: form.attr("action"),
               data: form.serialize(),
               dataType:"json",
               success: function(data) {
                  if ('SUCCESS' === data.statusMsg) {
                     // remove command from list
                     var elem = document.getElementById('divCmd_'+data.cmdid);
                     elem.parentElement.removeChild(elem);
                  } else {
                     alert(data.statusMsg);
                  }
               },
               error: function(jqXHR, textStatus, errorThrown) {
                  console.error(textStatus, errorThrown);
                  alert("ERROR: Please contact your CodevTT administrator");
               }
            });
            jQuery("#formRemoveFromCmd_dialog").dialog("close");
         });

         jQuery("#addToCmd_link").click(function(e) {
            e.preventDefault();
            // fill cmdCandidates
            jQuery.ajax({
               type: "GET",
               url: "{$ajaxPage}",
               data: "action=getCmdCandidates&bugid={$issueGeneralInfo.issueId}",
               dataType:"json",
               success: function(data) {
                  if ('SUCCESS' === data.statusMsg) {
                     // fill cbCmdCandidates
                     var cbCmds = jQuery(".cbCmdCandidates");
                     cbCmds.empty();
                     //cbCmds.select2('data', null);

                     var cmdCandidates = data.cmdCandidates;
                     for (var id in cmdCandidates) {
                        if (cmdCandidates.hasOwnProperty(id)) {
                           cbCmds.append(
                              jQuery('<option>').attr('value', id).append(cmdCandidates[id])
                           );
                        }
                     }
                  } else {
                     alert(data.statusMsg);
                  }
               },
               error: function(jqXHR, textStatus, errorThrown) {
                  console.error(textStatus, errorThrown);
                  alert("ERROR: Please contact your CodevTT administrator");
               }
            });


            jQuery("#formAddToCmd_dialog").dialog("open");
         });
         jQuery("#formAddToCmd_dialog").dialog({
            autoOpen: false,
            resizable: true,
            width: "auto",
            modal: true,
            buttons: {
               "{t}Add{/t}": function() {
                  jQuery("#formAddToCmd").submit();
               },
               Cancel: function() {
                  jQuery(this).dialog("close");
               }
            }
         });
         jQuery("#formAddToCmd").submit(function(event) {
            event.preventDefault();
            var form = jQuery(this);
            jQuery.ajax({
               type: form.attr("method"),
               url: form.attr("action"),
               data: form.serialize(),
               dataType:"json",
               success: function(data) {
                  if ('SUCCESS' === data.statusMsg) {
                     // add command to list
                     var imgObj = jQuery('<img></img>').attr('align', "absmiddle").attr('title', "{t}Remove from command{/t}").attr('src', "images/b_drop.png");
                     imgObj.attr('onclick', "removeFromCmd('"+data.cmdid+"', '"+data.cmdName+"');return false;");
                     var aObj = jQuery('<a></a>').attr('href', "management/command_info.php?cmdid="+data.cmdid).html(data.cmdName);
                     var spanObj = jQuery('<span></span>').addClass("pointer").append(imgObj);
                     var divCmdObj = jQuery('<div></div>').attr('id', 'divCmd_'+data.cmdid).append(spanObj).append(aObj);
                     jQuery("#cmdList").append(divCmdObj);
                  } else {
                     alert(data.statusMsg);
                  }
               },
               error: function(jqXHR, textStatus, errorThrown) {
                  console.error(textStatus, errorThrown);
                  alert("ERROR: Please contact your CodevTT administrator");
               }
            });
            jQuery("#formAddToCmd_dialog").dialog("close");
         });
         // =================================================================
         jQuery("#getMantisNotes_link").click(function(e) {
            e.preventDefault();
            jQuery.ajax({
               type: "GET",
               url: "{$ajaxPage}",
               data: "action=getMantisNotes&bugid={$issueGeneralInfo.issueId}",
               dataType:"json",
               success: function(data) {
                  if ('SUCCESS' === data.statusMsg) {
                     // fill notes table
                     jQuery("#divNotesInfo").hide();
                     jQuery("#divNotesTable").show();
                     jQuery("#tableMantisNotes tbody tr").remove();
                     jQuery.each(data.taskNotes, function(i, item) {
                         var $tr = jQuery('<tr>').append(
                             jQuery('<td>').text(item.dateSubmitted),
                             jQuery('<td>').text(item.reporterName),
                             jQuery('<td>').html(item.text)
                         );
                         var $line = $tr.wrap('<p>');
                         jQuery('#tableMantisNotes tbody').append($line);
                     });



                  } else {
                     console.error("Ajax statusMsg", data.statusMsg);
                     alert(data.statusMsg);
                  }
               },
               error: function(jqXHR, textStatus, errorThrown) {
                  console.error(textStatus, errorThrown);
                  alert("ERROR: Please contact your CodevTT administrator");
               }
            });
         });

      });
   </script>

   {else}
   <p class="center ui-state-error-text">{t}Please select a team to access this page.{/t}</p>
   {/if}
</div>
